---
- name: Configure kubectl on master
  hosts: MASTER
  become: true

  vars:
    kube_user: "sai"

  tasks:

    - name: Symlink kubectl
      file:
        src: /var/lib/rancher/rke2/bin/kubectl
        dest: /usr/local/bin/kubectl
        state: link
        mode: '0777'

    - name: Create .kube directory for user
      file:
        path: "/home/{{ kube_user }}/.kube"
        state: directory
        mode: '0755'
        owner: "{{ kube_user }}"
        group: "{{ kube_user }}"

    - name: Copy kubeconfig to user home
      command: cp /etc/rancher/rke2/rke2.yaml "/home/{{ kube_user }}/.kube/config"

    - name: Fix permissions
      file:
        path: "/home/{{ kube_user }}/.kube/config"
        owner: "{{ kube_user }}"
        group: "{{ kube_user }}"
        mode: '0600'

    # ⭐ FIXED TASK — SAFE FALLBACK FOR MASTER IP ⭐
    - name: Replace localhost with master IP
      replace:
        path: "/home/{{ kube_user }}/.kube/config"
        regexp: "127.0.0.1"
        replace: "{{ hostvars[inventory_hostname].ansible_host | default(inventory_hostname) }}"
